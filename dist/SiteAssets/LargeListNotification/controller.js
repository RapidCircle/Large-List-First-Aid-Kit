define(["Services/SPWebService","Services/ListService"],function(e,o){function i(e){o.GetView({ListId:_spPageContextInfo.pageListId,OData:"$select=ServerRelativeUrl,Id,PersonalView&$filter=Title eq '"+e.view_configuration.view_name+"'"}).done(function(i){if(i.d.results.length>0){if(0==e.Type){var n=i.d.results[0].ServerRelativeUrl;return void(window.location.href=window.location.protocol+"//"+window.location.host+n)}if(1==e.Type){var n=i.d.results[0].ServerRelativeUrl;return void(window.location.href=window.location.protocol+"//"+window.location.host+n+"?PageView=Personal&ShowWebPart={"+i.d.results[0].Id+"}")}}o.GetView({ListId:_spPageContextInfo.pageListId,OData:"$filter=DefaultView eq true&$expand=ViewFields"}).done(function(i){var n=i.d.results[0].ViewFields.SchemaXml,t={};t.__metadata={type:"SP.View"},t.Title=e.view_configuration.view_name,t.PersonalView=e.PersonalView,t.ViewData=n,t.ViewQuery=e.view_configuration.query,e.isLibrary?t.Scope=Constants.ViewScope.DefaultValue:t.Scope=Constants.ViewScope.RecursiveAll,o.AddView({ListId:_spPageContextInfo.pageListId,bodyContent:JSON.stringify(t)}).done(function(i){o.GetView({ListId:_spPageContextInfo.pageListId,OData:"$select=ServerRelativeUrl,Id&$filter=Title eq '"+e.view_configuration.view_name+"'"}).done(function(o){if(0==e.Type){var i=o.d.results[0].ServerRelativeUrl;return void(window.location.href=window.location.protocol+"//"+window.location.host+i)}if(1==e.Type){var i=o.d.results[0].ServerRelativeUrl;return void(window.location.href=window.location.protocol+"//"+window.location.host+i+"?PageView=Personal&ShowWebPart={"+o.d.results[0].Id+"}")}}).fail(function(e){console.error(Messages.ErrorRetrievingValues),console.error(e)})}).fail(function(e){console.error(e)})}).fail(function(e){console.error(e)})}).fail(function(e){console.error(e)})}function n(n){o.CheckPermissions([SP.PermissionKind.manageLists]).done(function(t){if(t){for(var r=null,s=0;s<Config.length;s++)if(Config[s].type==n){r=Config[s];break}o.GetList({ListId:_spPageContextInfo.pageListId,OData:"$select=BaseType"}).done(function(e){i(e.d.BaseType==Constants.SPBaseType.DocumentLibrary?{Type:0,PersonalView:!1,view_configuration:r,isLibrary:!0}:{Type:0,PersonalView:!1,view_configuration:r,isLibrary:!1})}).fail(function(e){console.error(e)})}else e.CheckPermissions([SP.PermissionKind.managePersonalViews]).done(function(e){if(e){for(var t=null,r=0;r<Config.length;r++)if(Config[r].type==n){t=Config[r];break}o.GetList({ListId:_spPageContextInfo.pageListId,OData:"$select=BaseType"}).done(function(e){i(e.d.BaseType==Constants.SPBaseType.DocumentLibrary?{Type:1,PersonalView:!0,view_configuration:t,isLibrary:!0}:{Type:1,PersonalView:!0,view_configuration:t,isLibrary:!0})}).fail(function(e){console.error(e)})}else alert(Messages.ErrorInsufficientPermission)}).fail(function(e){console.error("Error retrieing permissions for user"),console.error(e)})}).fail(function(e){console.error("Error retrieing permissions for user"),console.error(e)})}function t(){var e=_spPageContextInfo.serverRequestPath,o=e.split("/"),i=(o[o.length-1],SP.ClientContext.get_current()),n=i.get_web().get_lists().getById(_spPageContextInfo.pageListId).get_views();i.load(n,"Include(Id,ServerRelativeUrl)"),i.executeQueryAsync(function(e,o){for(var i=n.getEnumerator();i.moveNext();){var t=i.get_current(),r=t.get_serverRelativeUrl();if(r==_spPageContextInfo.serverRequestPath){var s=t.get_id(),a=_spPageContextInfo.webAbsoluteUrl+"/"+_spPageContextInfo.layoutsUrl+"/ViewEdit.aspx?List="+_spPageContextInfo.pageListId+"&View={"+s+"}";window.location.href=a;break}}},function(e,o){console.error(o.get_message())})}return{CreateView:n,RedirectToModifyView:t}});