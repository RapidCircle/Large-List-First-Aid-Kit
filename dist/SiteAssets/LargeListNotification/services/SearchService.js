define(["jquery"],function(e){var t={},r=this;this.requestDigest=null;var o=function(){var t=e.Deferred();return r.requestDigest&&r.requestDigest.expiresOn>new Date?t.resolve():(e.ajax({type:"POST",url:_spPageContextInfo.siteAbsoluteUrl+"/_api/contextinfo",headers:{accept:"application/json;odata=verbose"}}).done(function(e){var o=(new Date).getTime();r.requestDigest=e.d.GetContextWebInformation,r.requestDigest.expiresOn=o+1e3*e.d.GetContextWebInformation.FormDigestTimeoutSeconds-6e4,console.log("Token",r.requestDigest.FormDigestValue),t.resolve()}).fail(function(e){console.log("Error fetching Request Digest. Some parts won't work."),t.reject()}),t.promise())};return t.Query=function(t){var n=e.Deferred();return o().then(function(){e.ajax({url:_spPageContextInfo.siteAbsoluteUrl+"/_api/search/postquery",type:"POST",headers:{accept:"application/json;odata=verbose","content-type":"application/json;odata=verbose","X-RequestDigest":r.requestDigest.FormDigestValue},data:JSON.stringify(t)}).done(function(e){n.resolve(e)}).fail(function(e){n.reject(e)})},function(e){n.reject(e)}),n.promise()},t.GetManagedProperties=function(t){var r=e.Deferred();return e.ajax({url:_spPageContextInfo.siteAbsoluteUrl+"/_api/search/query?querytext='contenttype:"+t.ContentType+"+ListId:"+t.ListId+"'",type:"get",headers:{accept:"application/json;odata=verbose","content-type":"application/json;odata=verbose"}}).done(function(t){if(t.d.query.PrimaryQueryResult.RelevantResults.RowCount>0){for(var o=null,n=t.d.query.PrimaryQueryResult.RelevantResults.Table.Rows.results[0].Cells.results,s=0;s<n.length;s++)if("WorkId"==n[s].Key){o=n[s];break}e.ajax({url:_spPageContextInfo.siteAbsoluteUrl+"/_api/search/query?querytext='"+o.Key+":"+o.Value+"'&refiners='ManagedProperties(filter=600/0/*)'",type:"get",headers:{accept:"application/json;odata=verbose","content-type":"application/json;odata=verbose"}}).done(function(e){if(null==e.d.query.PrimaryQueryResult||null==e.d.query.PrimaryQueryResult.RefinementResults)r.reject(new Error({name:"RC Search Service Error",message:"Error detected. Could not retrieve managed properties.",htmlMessage:"The ManagedProperties property does not contain values. See https://github.com/wobba/SPO-Trigger-Reindex for more information on how to enable this feature.",toString:function(){return this.name+": "+this.message+" "+this.htmlMessage}}));else{var t=e.d.query.PrimaryQueryResult.RefinementResults.Refiners.results[0].Entries.results;r.resolve(t)}}).fail(function(e){r.reject(e)})}}),r.promise()},t});